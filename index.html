<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Volunteer Availability Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* (All CSS styles remain exactly the same as before) */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: white;
            padding: 25px 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 8px 20px rgba(106, 17, 203, 0.2);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        h1 {
            font-size: 2.2rem;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .subtitle {
            font-size: 1rem;
            opacity: 0.9;
            font-weight: 300;
        }

        .controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background-color: #4a6ee0;
            color: white;
        }

        .btn-primary:hover {
            background-color: #3a5bd0;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background-color: #fff;
            color: #4a6ee0;
            border: 2px solid #4a6ee0;
        }

        .btn-secondary:hover {
            background-color: #f0f4ff;
            transform: translateY(-2px);
        }

        .btn-print {
            background-color: #10b981;
            color: white;
        }

        .btn-print:hover {
            background-color: #0da271;
            transform: translateY(-2px);
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 30px;
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.08);
            padding: 25px;
            height: fit-content;
        }

        .card-title {
            font-size: 1.4rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: #2d3748;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-title i {
            color: #4a6ee0;
        }

        /* --- New layout controls --- */
        .day-tabs { display:flex; gap:8px; flex-wrap:wrap; margin-bottom:12px; }
        .day-tab { padding:8px 14px; border-radius:8px; background:#f1f5f9; cursor:pointer; border:1px solid #e2e8f0; font-weight:600; color:#334155; }
        .day-tab.selected { background:#4a6ee0; color:#fff; border-color:#4a6ee0; }

        .time-buttons { display:flex; gap:8px; flex-wrap:wrap; margin-bottom:12px; }
        .time-btn { padding:8px 12px; border-radius:8px; background:#fff; cursor:pointer; border:1px solid #e2e8f0; font-weight:500; color:#334155; }
        .time-btn.selected { background:#4a6ee0; color:#fff; border-color:#4a6ee0; }

        /* Compact result table */
        .compact-table { width:100%; border-collapse:collapse; font-size:0.95rem; }
        .compact-table th, .compact-table td { padding:8px; border-bottom:1px solid #e6eef8; text-align:left; }
        .compact-table th { background:#f8fafc; font-weight:700; color:#374151; }
        .compact-table tr:hover { background:#f8fafc; }

        .volunteers-list { max-height: 500px; overflow-y: auto; margin-top: 10px; }

        .volunteer-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #e2e8f0; cursor: pointer; transition: background-color 0.2s ease; }
        .volunteer-item:hover { background-color: #f8fafc; }
        .volunteer-item.selected { background-color: #e8eeff; border-left: 4px solid #4a6ee0; }

        .volunteer-info h4 { font-weight: 600; margin-bottom: 5px; }
        .volunteer-info p { font-size: 0.9rem; color: #64748b; }

        .volunteer-phone { background-color: #10b981; color: white; padding: 5px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 500; }

        .volunteer-details { margin-top: 20px; }

        .detail-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .volunteer-name { font-size: 1.8rem; font-weight: 700; color: #2d3748; }
        .volunteer-id { background-color: #4a6ee0; color: white; padding: 6px 15px; border-radius: 20px; font-size: 0.9rem; font-weight: 500; }

        .detail-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; margin-bottom: 25px; }
        .detail-item { background-color: #f8fafc; border-radius: 10px; padding: 18px; }
        .detail-label { font-size: 0.9rem; color: #64748b; margin-bottom: 8px; }
        .detail-value { font-size: 1.1rem; font-weight: 600; color: #2d3748; }

        .schedule-day { margin-bottom: 20px; }
        .day-schedule { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
        .class-slot { background-color: #e8eeff; color: #4a6ee0; padding: 8px 15px; border-radius: 20px; font-size: 0.9rem; font-weight: 500; }
        .no-class { background-color: #f1f5f9; color: #64748b; padding: 8px 15px; border-radius: 20px; font-size: 0.9rem; font-weight: 500; }
        .empty-state { text-align: center; padding: 40px 20px; color: #94a3b8; }
        .empty-state i { font-size: 3rem; margin-bottom: 15px; color: #cbd5e1; }
        .loading { text-align: center; padding: 30px; color: #4a6ee0; }
        .loading-spinner { display: inline-block; width: 40px; height: 40px; border: 4px solid #e2e8f0; border-top: 4px solid #4a6ee0; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        footer { text-align: center; padding: 20px; color: #64748b; font-size: 0.9rem; border-top: 1px solid #e2e8f0; margin-top: 30px; }

        /* Print Styles */
        @media print {
            .btn, .controls, footer { display: none !important; }
            .card { box-shadow: none; border: 1px solid #ddd; }
            .time-slots, .volunteers-list { max-height: none; overflow: visible; }
        }

        /* Login overlay styles */
        #loginOverlay { backdrop-filter: blur(4px); }
        .login-card { width: 360px; max-width: calc(100% - 40px); background: linear-gradient(180deg,#ffffff 0%, #fbfdff 100%); padding:22px;border-radius:14px;box-shadow:0 20px 50px rgba(2,6,23,0.35); border:1px solid rgba(74,110,224,0.08); }
        .login-title { margin:0 0 6px 0; font-size:1.25rem; color:#0f172a; font-weight:700; }
        .login-sub { margin:0 0 12px 0; color:#475569; font-size:0.95rem; }
        .login-input { width:100%; padding:12px; margin:8px 0 12px 0; border-radius:10px; border:1px solid #e6eef8; font-size:0.95rem; }
        .login-row { display:flex; gap:10px; justify-content:flex-end; margin-top:6px; }
        .login-small { font-size:0.85rem; color:#475569; }
        @media (max-width:420px) { .login-card{padding:16px} .login-title{font-size:1.1rem} }
    </style>
</head>
<body>
    <!-- Login overlay: placed before main app so it blocks UI until successful login -->
    <div id="loginOverlay" style="position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(10,11,13,0.45);z-index:9999;">
        <div class="login-card" role="dialog" aria-modal="true" aria-label="Login dialog">
            <h2 class="login-title">Welcome back</h2>
            <p class="login-sub">Sign in to continue to the Volunteer Availability Dashboard — access is protected by SHA-256 hashes stored in the file.</p>

            <label class="login-small" for="loginUsername">Username</label>
            <input id="loginUsername" type="text" class="login-input" placeholder="teamleader">

            <label class="login-small" for="loginPassword">Password</label>
            <input id="loginPassword" type="password" class="login-input" placeholder="••••••••••">

            <div class="login-row">
                <button id="loginBtn" class="btn btn-primary" style="padding:10px 16px;border-radius:10px">Sign In</button>
            </div>

            <div id="loginMsg" style="margin-top:12px;color:#b91c1c;font-size:0.95rem;display:none"></div>

            <hr style="margin:14px 0;border:none;border-top:1px solid #eef2ff">
            <div class="login-small">Enter your credentials to sign in.</div>
        </div>
    </div>

    <div class="container">
        <header>
            <div class="header-content">
                <div>
                    <h1>Volunteer Availability Dashboard</h1>
                    <p class="subtitle">Click on a day then select start and end time to find volunteers free for the whole period</p>
                    <p class="subtitle" style="margin-top: 5px; font-size: 0.9rem;">
                        <i class="fas fa-cloud-download-alt"></i> Data loaded directly from Google Sheets
                    </p>
                </div>
                <div class="controls">
                    <button class="btn btn-primary" id="refreshBtn">
                        <i class="fas fa-sync-alt"></i> Refresh Data
                    </button>
                    <button class="btn btn-secondary" id="clearSelectionBtn">
                        <i class="fas fa-times"></i> Clear Selection
                    </button>
                    <button class="btn btn-print" id="printBtn">
                        <i class="fas fa-print"></i> Print List
                    </button>

                    <!-- Search input (dynamic - no button) -->
                    <div style="display:flex; gap:8px; align-items:center;">
                        <input id="searchInput" type="search" placeholder="Search volunteer by name" style="padding:10px; border-radius:8px; border:1px solid #e2e8f0; width:220px;">
                        <button class="btn" id="clearSearchBtn" title="Clear search" style="background:#fff;color:#64748b;border:1px solid #e2e8f0;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <div class="main-content">
            <!-- Controls Panel (day + start/end) -->
            <div class="card">
                <h2 class="card-title"><i class="far fa-calendar-alt"></i> Select Day & Time Range</h2>
                <p>Choose a day, then choose start and end time (buttons). Results show volunteers free for the entire selected period.</p>

                <div class="day-tabs" id="dayTabsContainer"></div>

                <h4 style="margin-top:10px; margin-bottom:6px;">Start Time</h4>
                <div class="time-buttons" id="startTimeContainer"></div>

                <h4 style="margin-top:10px; margin-bottom:6px;">End Time</h4>
                <div class="time-buttons" id="endTimeContainer"></div>

                <div id="selectedSlotInfo" style="margin-top: 20px; padding: 12px; background-color: #f0f7ff; border-radius: 8px; display: none;">
                    <strong>Selected:</strong> <span id="selectedSlotText"></span>
                </div>
            </div>

            <!-- Available Volunteers Panel (compact table) -->
            <div class="card">
                <h2 class="card-title"><i class="fas fa-users"></i> Volunteers</h2>
                <div id="dataStatus">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        <p>Loading data from Google Sheets...</p>
                        <p style="font-size: 0.9rem; color: #64748b;">This may take a few seconds</p>
                    </div>
                </div>

                <div class="volunteers-list" id="volunteersList">
                    <!-- Volunteers list will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Volunteer Details Panel -->
        <div class="card" id="volunteerDetailsPanel" style="display: none;">
            <div class="detail-header">
                <h2 class="volunteer-name" id="detailName">Volunteer Name</h2>
                <span class="volunteer-id" id="detailId">ID: 23-xxxxx-x</span>
            </div>

            <div class="detail-grid">
                <div class="detail-item">
                    <div class="detail-label">Department</div>
                    <div class="detail-value" id="detailDepartment">CSE</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Phone Number</div>
                    <div class="detail-value" id="detailPhone">+880xxxxxxxxx</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Availability Status</div>
                    <div class="detail-value" id="detailStatus">Available</div>
                </div>
            </div>

            <h3 style="margin: 25px 0 15px; color: #2d3748;">Weekly Class Schedule</h3>
            <div id="detailSchedule">
                <!-- Schedule will be generated dynamically -->
            </div>
        </div>

        <footer>
            <p>Volunteer Availability Dashboard &copy; 2023 | Data fetched automatically from Google Sheets</p>
            <p>Click on volunteer rows to view their complete schedule and contact information</p>
        </footer>
    </div>

    <script>
        // ============================================
        // CONFIGURATION - SET YOUR GOOGLE SHEET URL HERE
        // ============================================
        const GOOGLE_SHEETS_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR0N0LWqHVntBYrWP8KKkU_8n-4MxCHftC3CzqdNh0FQYHwh6SxOkQPzzycrM6czbvW_FucZMcNYrvj/pub?output=csv';

        // ============================================
        // DATA / STATE
        // ============================================
        const days = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday"];
        // start times (allowed selections) and end times (must be after start)
        const startTimes = [
            "8:00 AM",
            "9:00 AM",
            "10:00 AM",
            "11:00 AM",
            "12:00 PM",
            "1:00 PM",
            "2:00 PM",
            "3:00 PM"
        ];
        const endTimes = [
            "9:00 AM",
            "10:00 AM",
            "11:00 AM",
            "12:00 PM",
            "1:00 PM",
            "2:00 PM",
            "3:00 PM",
            "4:00 PM",
            "5:00 PM"
        ];

        let volunteersData = [];
        let selectedDay = null;
        let selectedStart = null;
        let selectedEnd = null;
        let selectedVolunteer = null;
        let availableVolunteers = [];

        // DOM
        const dayTabsContainer = document.getElementById('dayTabsContainer');
        const startTimeContainer = document.getElementById('startTimeContainer');
        const endTimeContainer = document.getElementById('endTimeContainer');
        const selectedSlotInfo = document.getElementById('selectedSlotInfo');
        const selectedSlotText = document.getElementById('selectedSlotText');
        const volunteersList = document.getElementById('volunteersList');
        const dataStatus = document.getElementById('dataStatus');
        const volunteerDetailsPanel = document.getElementById('volunteerDetailsPanel');

        const refreshBtn = document.getElementById('refreshBtn');
        const clearSelectionBtn = document.getElementById('clearSelectionBtn');
        const printBtn = document.getElementById('printBtn');
        const searchInput = document.getElementById('searchInput');
        const clearSearchBtn = document.getElementById('clearSearchBtn');

        // ============================================
        // UTIL: time parsing & overlap
        // ============================================
        function timeToMinutes(timeStr) {
            if (!timeStr) return null;
            const parts = timeStr.trim().split(' ');
            if (parts.length < 2) return null;
            const [time, modifier] = [parts[0], parts[1]];
            const [hoursStr, minutesStr] = time.split(':');
            let hours = parseInt(hoursStr, 10);
            const minutes = parseInt(minutesStr || '0', 10);
            if (modifier.toUpperCase() === 'PM' && hours !== 12) hours += 12;
            if (modifier.toUpperCase() === 'AM' && hours === 12) hours = 0;
            return hours * 60 + minutes;
        }

        function timeRangesOverlap(range1Start, range1End, range2Start, range2End) {
            const s1 = timeToMinutes(range1Start);
            const e1 = timeToMinutes(range1End);
            const s2 = timeToMinutes(range2Start);
            const e2 = timeToMinutes(range2End);
            if ([s1,e1,s2,e2].some(v => v === null)) return false;
            return !(e1 <= s2 || s1 >= e2);
        }

        // ============================================
        // FETCH / PARSE CSV
        // ============================================
        async function fetchDataFromGoogleSheets() {
            showLoadingState();
            try {
                const fetchUrl = GOOGLE_SHEETS_CSV_URL + (GOOGLE_SHEETS_CSV_URL.includes('?') ? '&' : '?') + 't=' + Date.now();
                const response = await fetch(fetchUrl, { cache: 'no-store', headers: { 'Cache-Control': 'no-cache' } });
                if (!response.ok) throw new Error(`Failed to fetch data: ${response.status}`);
                const csvText = await response.text();
                volunteersData = parseCSVData(csvText);
                if (!volunteersData.length) throw new Error("No data found in the Google Sheet");
                showDataLoadedState();
                renderControls();
            } catch (err) {
                console.error(err);
                showErrorState(err.message);
                volunteersData = getSampleData();
                showDataLoadedState();
                renderControls();
            }
        }

        function parseCSVData(csvText) {
            const volunteers = [];
            const lines = csvText.split('\n').map(l => l.replace(/\r/g,''));
            if (lines.length < 2) return volunteers;
            const headers = parseCSVLine(lines[0]);
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                const rowData = parseCSVLine(line);
                if (rowData.length < 9) continue;
                const volunteer = {
                    name: rowData[0] || "Unknown",
                    studentId: rowData[1] || "N/A",
                    phone: rowData[2] || "N/A",
                    department: rowData[3] || "Unknown",
                    schedule: {
                        Sunday: parseTimeSlots(rowData[4]),
                        Monday: parseTimeSlots(rowData[5]),
                        Tuesday: parseTimeSlots(rowData[6]),
                        Wednesday: parseTimeSlots(rowData[7]),
                        Thursday: parseTimeSlots(rowData[8])
                    }
                };
                if (volunteer.name && volunteer.name !== "Unknown") volunteers.push(volunteer);
            }
            return volunteers;
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                const nextChar = line[i+1];
                if (char === '"' && !inQuotes) { inQuotes = true; continue; }
                if (char === '"' && inQuotes && nextChar === '"') { current += '"'; i++; continue; }
                if (char === '"' && inQuotes) { inQuotes = false; continue; }
                if (char === ',' && !inQuotes) { result.push(current.trim()); current = ''; continue; }
                current += char;
            }
            result.push(current.trim());
            return result;
        }

        function parseTimeSlots(timeString) {
            if (!timeString || timeString.toLowerCase().includes('no classes') || timeString.trim() === '') return ["No classes"];
            return timeString.split(',').map(s => s.trim()).filter(Boolean);
        }

        function getSampleData() {
            return [
                { name: "Fazilatun Nesa Rodshi", studentId: "23-52284-2", phone: "01325404797", department: "BBA", schedule: { Sunday: ["10:10 AM – 12:10 PM","12:10 PM – 2:10 PM"], Monday: ["10:10 AM – 12:10 PM"], Tuesday: ["10:10 AM – 12:10 PM","12:10 PM – 2:10 PM"], Wednesday: ["10:10 AM – 12:10 PM"], Thursday: ["2:20 PM – 4:20 PM"] } },
                { name: "Fahima Sultana Smrity", studentId: "23-51277-1", phone: "01319333679", department: "CSE", schedule: { Sunday: ["10:10 AM – 12:10 PM","1:00 PM – 2:30 PM"], Monday: ["11:00 AM – 2:00 PM"], Tuesday: ["10:10 AM – 12:10 PM","1:00 PM – 2:30 PM"], Wednesday: ["11:00 AM – 2:00 PM"], Thursday: ["8:00 AM – 10:00 AM"] } }
            ];
        }

        // ============================================
        // UI: control rendering & selection
        // ============================================
        function renderControls() {
            renderDayTabs();
            renderStartEndButtons();
            clearSelections(false);
            updateVolunteersCount();
        }

        function renderDayTabs() {
            dayTabsContainer.innerHTML = '';
            days.forEach(d => {
                const btn = document.createElement('div');
                btn.className = 'day-tab';
                btn.textContent = d;
                btn.addEventListener('click', () => selectDay(d));
                if (selectedDay === d) btn.classList.add('selected');
                dayTabsContainer.appendChild(btn);
            });
        }

        function renderStartEndButtons() {
            startTimeContainer.innerHTML = '';
            endTimeContainer.innerHTML = '';
            // render start time buttons (single times)
            startTimes.forEach(t => {
                const b = document.createElement('div');
                b.className = 'time-btn';
                b.textContent = t;
                b.addEventListener('click', () => selectStart(t));
                if (selectedStart === t) b.classList.add('selected');
                startTimeContainer.appendChild(b);
            });

            // render end time buttons (single times)
            endTimes.forEach(t => {
                const b = document.createElement('div');
                b.className = 'time-btn';
                b.textContent = t;
                b.addEventListener('click', () => selectEnd(t));
                if (selectedEnd === t) b.classList.add('selected');
                endTimeContainer.appendChild(b);
            });
        }

        function selectDay(day) {
            selectedDay = day;
            selectedStart = null;
            selectedEnd = null;
            selectedVolunteer = null;
            renderDayTabs();
            renderStartEndButtons();
            selectedSlotInfo.style.display = 'none';
            availableVolunteers = [];
            renderVolunteersList();
        }

        function selectStart(slot) {
            selectedStart = slot;
            // if end exists and is earlier than start, clear end
            if (selectedEnd && !isEndAfterStart(selectedStart, selectedEnd)) selectedEnd = null;
            renderStartEndButtons();
            applySelectionIfReady();
        }

        function selectEnd(slot) {
            selectedEnd = slot;
            // if start exists and end is before start, swap or clear; here clear start if invalid
            if (selectedStart && !isEndAfterStart(selectedStart, selectedEnd)) {
                // make sure end is always after start: if not, set start to previous earliest or clear
                selectedStart = null;
            }
            renderStartEndButtons();
            applySelectionIfReady();
        }

        function isEndAfterStart(startTime, endTime) {
            if (!startTime || !endTime) return false;
            return timeToMinutes(endTime) > timeToMinutes(startTime);
        }

        function applySelectionIfReady() {
            if (selectedDay && selectedStart && selectedEnd) {
                // start/end are single times now
                selectedSlotText.textContent = `${selectedDay}, ${selectedStart} – ${selectedEnd}`;
                selectedSlotInfo.style.display = 'block';
                findAvailableVolunteersForRange(selectedDay, selectedStart, selectedEnd);
            } else {
                availableVolunteers = [];
                renderVolunteersList();
            }
            updateVolunteersCount();
        }

        // ============================================
        // SEARCH (dynamic typing)
        // ============================================
        function applySearchFilter(list) {
            const q = (searchInput.value || '').trim().toLowerCase();
            if (!q) return list;
            return list.filter(v => (v.name || '').toLowerCase().includes(q));
        }

        searchInput.addEventListener('input', () => {
            // If a time range is active, filter availableVolunteers; else filter all volunteers
            if (selectedDay && selectedStart && selectedEnd) {
                const filtered = applySearchFilter(availableVolunteers);
                renderVolunteersList(filtered);
            } else {
                const pool = applySearchFilter(volunteersData);
                renderVolunteersList(pool);
            }
        });

        if (clearSearchBtn) {
            clearSearchBtn.addEventListener('click', () => {
                searchInput.value = '';
                if (selectedDay && selectedStart && selectedEnd) renderVolunteersList(availableVolunteers);
                else renderVolunteersList([]);
            });
        }

        // ============================================
        // FIND volunteers free for whole range
        // ============================================
        function findAvailableVolunteersForRange(day, rangeStartTime, rangeEndTime) {
            availableVolunteers = volunteersData.filter(vol => {
                const daySched = vol.schedule[day];
                if (!daySched || daySched[0] === "No classes") return true;
                // if any class overlaps with selected period, volunteer is NOT available
                const hasOverlap = daySched.some(classTime => {
                    if (classTime === "No classes") return false;
                    const [classStart, classEnd] = classTime.split(' – ');
                    return timeRangesOverlap(rangeStartTime, rangeEndTime, classStart, classEnd);
                });
                return !hasOverlap;
            });
            // apply search filter if any
            const q = (searchInput.value || '').trim().toLowerCase();
            const toRender = q ? availableVolunteers.filter(v => (v.name||'').toLowerCase().includes(q)) : availableVolunteers;
            renderVolunteersList(toRender);
        }

        // ============================================
        // RENDER volunteers (compact table when range selected)
        // ============================================
        function renderVolunteersList(optionalList) {
            const list = Array.isArray(optionalList) ? optionalList : (selectedDay && selectedStart && selectedEnd ? availableVolunteers : []);
            volunteersList.innerHTML = '';

            if (!list || list.length === 0) {
                volunteersList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-user-slash"></i>
                        <h3>No volunteers found</h3>
                        <p>No volunteers match the current selection or search.</p>
                    </div>
                `;
                updateVolunteersCount();
                return;
            }

            // If time range is selected, use compact table
            if (selectedDay && selectedStart && selectedEnd) {
                const tbl = document.createElement('table');
                tbl.className = 'compact-table';
                tbl.innerHTML = `
                    <thead>
                        <tr><th>Name</th><th>ID</th><th>Phone</th></tr>
                    </thead>
                    <tbody>
                        ${list.map(v => `<tr data-id="${v.studentId}"><td>${escapeHtml(v.name)}</td><td>${escapeHtml(v.studentId)}</td><td>${escapeHtml(formatPhoneNumber(v.phone))}</td></tr>`).join('')}
                    </tbody>
                `;
                // row click opens details
                tbl.querySelectorAll('tbody tr').forEach(r => {
                    r.addEventListener('click', () => {
                        const id = r.dataset.id;
                        const vol = volunteersData.find(x => x.studentId === id);
                        if (vol) selectVolunteer(vol);
                    });
                });
                volunteersList.appendChild(tbl);
            } else {
                // show simple list (when no range)
                list.forEach(volunteer => {
                    const volunteerItem = document.createElement('div');
                    volunteerItem.className = 'volunteer-item';
                    volunteerItem.innerHTML = `
                        <div class="volunteer-info">
                            <h4>${escapeHtml(volunteer.name)}</h4>
                            <p>${escapeHtml(volunteer.department)} • ID: ${escapeHtml(volunteer.studentId)}</p>
                        </div>
                        <div class="volunteer-phone">
                            <i class="fas fa-phone"></i> ${escapeHtml(formatPhoneNumber(volunteer.phone))}
                        </div>
                    `;
                    volunteerItem.addEventListener('click', () => selectVolunteer(volunteer));
                    volunteersList.appendChild(volunteerItem);
                });
            }

            updateVolunteersCount();
        }

        // ============================================
        // helpers
        // ============================================
        function escapeHtml(s) { return (s||'').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

        function updateVolunteersCount() {
            const volunteersCountElement = document.getElementById('volunteersCount');
            if (volunteersCountElement) {
                if (selectedDay && selectedStart && selectedEnd) {
                    volunteersCountElement.innerHTML = `<i class="fas fa-users"></i> ${availableVolunteers.length} volunteer${availableVolunteers.length !== 1 ? 's' : ''} available for ${selectedDay}`;
                } else {
                    volunteersCountElement.innerHTML = `<i class="fas fa-users"></i> ${volunteersData.length} volunteers loaded`;
                }
            }
        }

        function formatPhoneNumber(phone) {
            if (!phone || phone === "N/A") return "N/A";
            const cleanPhone = phone.toString().trim();
            if (cleanPhone.length === 11 && cleanPhone.startsWith('01')) {
                return `${cleanPhone.substring(0, 4)}-${cleanPhone.substring(4, 8)}-${cleanPhone.substring(8)}`;
            }
            if (cleanPhone.length === 10) {
                return `${cleanPhone.substring(0, 4)}-${cleanPhone.substring(4, 7)}-${cleanPhone.substring(7)}`;
            }
            return cleanPhone;
        }

        // ============================================
        // select volunteer -> details panel
        // ============================================
        function selectVolunteer(volunteer) {
            selectedVolunteer = volunteer;
            document.querySelectorAll('.volunteer-item').forEach(el => el.classList.remove('selected'));
            volunteerDetailsPanel.style.display = 'block';
            document.getElementById('detailName').textContent = volunteer.name;
            document.getElementById('detailId').textContent = `ID: ${volunteer.studentId}`;
            document.getElementById('detailDepartment').textContent = volunteer.department;
            document.getElementById('detailPhone').textContent = formatPhoneNumber(volunteer.phone);
            const isAvailableNow = availableVolunteers.some(v => v.studentId === volunteer.studentId);
            const statusElement = document.getElementById('detailStatus');
            statusElement.textContent = (selectedDay && selectedStart && selectedEnd && isAvailableNow) ? `Available for selected period` : `Not available for selected period`;
            statusElement.style.color = isAvailableNow ? "#10b981" : "#ef4444";
            renderVolunteerSchedule(volunteer);
            volunteerDetailsPanel.scrollIntoView({ behavior: 'smooth' });
        }

        function renderVolunteerSchedule(volunteer) {
            const scheduleContainer = document.getElementById('detailSchedule');
            scheduleContainer.innerHTML = '';
            days.forEach(day => {
                const scheduleDay = document.createElement('div');
                scheduleDay.className = 'schedule-day';
                const dayHeader = document.createElement('h4');
                dayHeader.textContent = day;
                dayHeader.style.marginBottom = '10px';
                dayHeader.style.color = selectedDay === day ? '#4a6ee0' : '#2d3748';
                scheduleDay.appendChild(dayHeader);

                const daySchedule = document.createElement('div');
                daySchedule.className = 'day-schedule';
                if (!volunteer.schedule[day] || volunteer.schedule[day][0] === "No classes") {
                    const noClass = document.createElement('span');
                    noClass.className = 'no-class';
                    noClass.textContent = 'No classes';
                    daySchedule.appendChild(noClass);
                } else {
                    volunteer.schedule[day].forEach(classTime => {
                        const classSlot = document.createElement('span');
                        classSlot.className = 'class-slot';
                        classSlot.textContent = classTime;
                        if (selectedDay === day && selectedStart && selectedEnd) {
                            const startTime = selectedStart;
                            const endTime = selectedEnd;
                            const [classStart, classEnd] = classTime.split(' – ');
                            if (timeRangesOverlap(startTime, endTime, classStart, classEnd)) {
                                classSlot.style.backgroundColor = '#fef3c7';
                                classSlot.style.color = '#92400e';
                            }
                        }
                        daySchedule.appendChild(classSlot);
                    });
                }
                scheduleDay.appendChild(daySchedule);
                scheduleContainer.appendChild(scheduleDay);
            });
        }

        // ============================================
        // print (compact table with 3 columns)
        // ============================================
        function printList() {
            const list = (availableVolunteers && availableVolunteers.length) ? availableVolunteers : (selectedVolunteer ? [selectedVolunteer] : []);
            if (!list.length) {
                alert("Please select a time range or volunteer first to print.");
                return;
            }
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Volunteer List</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 10px; font-size: 12px; color:#222; }
                        table { width:100%; border-collapse: collapse; }
                        th, td { padding:6px 8px; border:1px solid #ddd; text-align:left; }
                        th { background:#f3f4f6; font-weight:700; }
                    </style>
                </head>
                <body>
                    <h3>Volunteer List${selectedDay ? ' — ' + selectedDay : ''}</h3>
                    <p>Period: ${selectedStart && selectedEnd ? `${selectedStart} – ${selectedEnd}` : 'Not specified'}</p>
                    <table>
                        <thead><tr><th>Name</th><th>ID</th><th>Phone</th></tr></thead>
                        <tbody>
                            ${list.map(v => `<tr><td>${escapeHtml(v.name)}</td><td>${escapeHtml(v.studentId)}</td><td>${escapeHtml(formatPhoneNumber(v.phone))}</td></tr>`).join('')}
                        </tbody>
                    </table>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.focus();
            setTimeout(() => { printWindow.print(); printWindow.close(); }, 300);
        }

        // ============================================
        // misc: states, init, events
        // ============================================
        function showLoadingState() {
            dataStatus.innerHTML = `
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>Loading data from Google Sheets...</p>
                    <p style="font-size: 0.9rem; color: #64748b;">Fetching ${volunteersData.length === 0 ? 'initial' : 'updated'} data...</p>
                </div>
            `;
            volunteersList.innerHTML = `<div class="empty-state"><i class="fas fa-cloud-download-alt"></i><h3>Loading Data</h3><p>Please wait while we fetch the latest volunteer information</p></div>`;
        }

        function showDataLoadedState() {
            dataStatus.innerHTML = `
                <p id="volunteersCount" style="margin-bottom: 10px;">
                    <i class="fas fa-check-circle" style="color: #10b981;"></i>
                    Loaded ${volunteersData.length} volunteers from Google Sheets
                </p>
                <p style="font-size: 0.9rem; color: #64748b; margin-bottom: 15px;">
                    Select a day and a time range to see volunteers available for the whole period
                </p>
            `;
        }

        function showErrorState(errorMessage) {
            dataStatus.innerHTML = `
                <div style="padding: 15px; background-color: #fee; border-radius: 8px; color: #dc2626;">
                    <p><i class="fas fa-exclamation-triangle"></i> <strong>Error loading data:</strong></p>
                    <p style="font-size: 0.9rem; margin-top: 5px;">${escapeHtml(errorMessage)}</p>
                    <p style="font-size: 0.9rem; margin-top: 10px;">Using sample data. Click Refresh to try again.</p>
                </div>
            `;
        }

        function clearSelections(resetUI = true) {
            selectedDay = null;
            selectedStart = null;
            selectedEnd = null;
            selectedVolunteer = null;
            availableVolunteers = [];
            if (resetUI) {
                selectedSlotInfo.style.display = 'none';
                renderDayTabs();
                renderStartEndButtons();
                renderVolunteersList([]);
            } else {
                renderDayTabs();
                renderStartEndButtons();
            }
            updateVolunteersCount();
        }

        function init() {
            renderControls();
            setupEventListeners();
            fetchDataFromGoogleSheets();
        }

        function setupEventListeners() {
            refreshBtn.addEventListener('click', fetchDataFromGoogleSheets);
            clearSelectionBtn.addEventListener('click', () => clearSelections());
            printBtn.addEventListener('click', printList);

            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey && e.key === 'r') { e.preventDefault(); fetchDataFromGoogleSheets(); }
                if (e.key === 'Escape') { clearSelections(); }
                if (e.ctrlKey && e.key === 'p') { e.preventDefault(); printList(); }
            });
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>

    <!-- Client-side login & hash helper (replace placeholders below with your generated hashes) -->
    <script>
        // === PLACE YOUR HASHES HERE ===
        // The hashes are embedded below for the expected credentials.
        // Hashes for provided credentials:
        // username: teamleader  (lowercased before hashing)
        // password: shomoyleader
        const STORED_USER = 'a13ced332eef4dd59a416acfcecb808765f4e1ca745f7477dfcd580eac113599';
        const STORED_PASS = '78b5d26ad5c8e3349f5d61dc46b30d23a85524f0da0ea169d0537d026ea1d222';

        // Convert text -> SHA-256 hex string
        // Uses Web Crypto when available; otherwise dynamically loads CryptoJS as a fallback.
        async function sha256hex(text) {
            if (window.crypto && window.crypto.subtle && typeof window.crypto.subtle.digest === 'function') {
                const enc = new TextEncoder();
                const data = enc.encode(text);
                const hashBuffer = await window.crypto.subtle.digest('SHA-256', data);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            }

            // Fallback: use CryptoJS if already present
            if (window.CryptoJS && typeof window.CryptoJS.SHA256 === 'function') {
                return window.CryptoJS.SHA256(text).toString(window.CryptoJS.enc.Hex);
            }

            // Dynamically load CryptoJS from CDN as a fallback (only if needed)
            await new Promise((resolve, reject) => {
                const scriptId = 'cryptojs-cdn';
                if (document.getElementById(scriptId)) return resolve();
                const s = document.createElement('script');
                s.id = scriptId;
                s.src = 'https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js';
                s.crossOrigin = 'anonymous';
                s.onload = () => resolve();
                s.onerror = () => reject(new Error('Failed to load CryptoJS fallback'));
                document.head.appendChild(s);
            });

            if (window.CryptoJS && typeof window.CryptoJS.SHA256 === 'function') {
                return window.CryptoJS.SHA256(text).toString(window.CryptoJS.enc.Hex);
            }

            throw new Error('No SHA-256 implementation available');
        }

        function showLoginMessage(msg, isError = true) {
            const el = document.getElementById('loginMsg');
            el.style.display = msg ? 'block' : 'none';
            el.style.color = isError ? '#b91c1c' : '#065f46';
            el.textContent = msg || '';
        }

        async function attemptLogin() {
            try {
                const user = (document.getElementById('loginUsername')||{}).value || '';
                const pass = (document.getElementById('loginPassword')||{}).value || '';
                if (!user || !pass) { showLoginMessage('Please enter username and password.'); return; }
                const userHash = await sha256hex(user.trim().toLowerCase());
                const passHash = await sha256hex(pass);
                if (userHash === STORED_USER && passHash === STORED_PASS) {
                    sessionStorage.setItem('app_logged_in', '1');
                    document.getElementById('loginOverlay').style.display = 'none';
                    showLoginMessage('', false);
                } else {
                    showLoginMessage('Invalid credentials.');
                }
            } catch (err) {
                console.error('Login error:', err);
                showLoginMessage('Unable to compute crypto digest in this environment. If you are hosting via file:// or insecure HTTP, open the page over HTTPS or localhost.');
            }
        }

        // generateHashes removed (not needed)
        document.getElementById('loginBtn').addEventListener('click', (e) => { e.preventDefault(); attemptLogin(); });

        // Allow pressing Enter in password field to submit
        document.getElementById('loginPassword').addEventListener('keydown', (e) => { if (e.key === 'Enter') attemptLogin(); });

        // Persist session during the browser tab session
        document.addEventListener('DOMContentLoaded', () => {
            try {
                if (sessionStorage.getItem('app_logged_in') === '1') {
                    document.getElementById('loginOverlay').style.display = 'none';
                }
                // Pre-fill placeholders to help the user (optional)
                const u = document.getElementById('loginUsername');
                const p = document.getElementById('loginPassword');
                if (u && !u.value) u.value = 'teamleader';
                if (p && !p.value) p.value = '';
            } catch (err) {
                // ignore storage errors
            }
        });

        // NOTE (security): This approach stores only hashes (not plaintext). However, it's important to
        // understand that any client-side secret or hash included in a webpage can be read by someone
        // with access to the page (inspect/network). For real protection, move authentication to a
        // server and never embed secrets in client-side code.
    </script>
</body>
</html>